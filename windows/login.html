<!DOCTYPE HTML>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" type="text/css" href="assets/css/bootstrap.min.css" />
    <title id="frameTitle">{{ language.loginPageTitle }}</title>
  <style>
    .right-buttons {
      text-align: right;
    }

    .center-text {
      text-align: center;
    }

    .signin-text {
      margin-top: 5%;
    }

  </style>
      <script>window.$ = window.jQuery = require('jquery');</script>
      <script src="assets/lib/popper.min.js"></script>
      <script src="assets/lib/bootstrap.min.js"></script>
      <script src="/socket.io/socket.io.js"></script>
      <script type="text/javascript">
        const ipcRenderer = require('electron').ipcRenderer;

        $(document).ready(() => {
          
          const loginSocket = io(`${document.location.origin}/login`);
          const mainSocket = io();
         
          loginSocket.on('setupLanguage', (lang) => {
              $('#frameTitle').html(lang.loginPageTitle);
              $('#lblUsername').html(lang.username);
              $('#lblPassword').html(lang.password);
              $('#systemLanguage').html(lang.systemLanguage);
              $('#username').attr("placeholder", lang.hitYourUsername);
              $('#password').attr("placeholder", lang.password);
              $('#saveUsernameInfo').text(lang.saveUsername);
              $('#btnLogin').text(lang.login);
              $('#btnExit').text(lang.exit);
              $('#dontHaveAnAccount').html(lang.dontHaveAnAccount);
              $('#createAccount').text(lang.createYourOwnAccount);
              $('#pebutraInfo').text(lang.pebutraInfo);

              $('#username').removeClass('is-invalid');
              $('#password').removeClass('is-invalid');
          });

          ipcRenderer.on('loginValidationResult', (event, result) => {

            $('#username').removeClass('is-invalid');
            $('#password').removeClass('is-invalid');

            if (!result.validAll) {
                const validationResults = result.validationResults;
                
                for (vr of validationResults) {
                  if (!vr.valid) {
                    $('#' + vr.validationName).addClass('is-invalid');
                    $('#' + vr.validationName + 'InvalidFeedback').text(vr.message);
                  }
                  
                }

              }
              else {
                  console.log('Valid all!');
                  //TODO: Implement login process.
                  const user = {
                    username : $('#username').val(),
                    password : $('#password').val()
                  };

                  ipcRenderer.send('performLogin', user);
              }
          });

            $("#cmbLanguages").change(() => {
                const newLanguage = $('#cmbLanguages').val();
                loginSocket.emit('languageChanged', newLanguage);
              });

            $('#btnExit').click(() => {
                ipcRenderer.send('exitApplication');
            });

            $('#btnLogin').click(() => {
                const user = {
                  username : $('#username').val(),
                  password : $('#password').val()
                };

                ipcRenderer.send('validateLoginForm', user);
            });
                      
        });
        
      </script>
  </head>
  <body>
      <div class="container">
            <div class="row">
              <div class="col-4 mx-auto"><img class="img-fluid" src="assets/img/logo.png" /></div>
            </div>
            <div class="row">
              <div class="col-sm-6 mx-auto">
                  <form method="POST" id="loginForm" class="needs-validation" action="/">
                      <div class="form-group">
                        <label for="username" id="lblUsername">{{language.username}}</label>
                        <input type="text" class="form-control form-control-sm" id="username" placeholder="{{language.hitYourUsername}}">
                        <div id="usernameInvalidFeedback" class="invalid-feedback "></div>
                      </div>
                      <div class="form-group">
                        <label for="password" id="lblPassword">{{language.password}}</label>
                        <input type="password" class="form-control form-control-sm" id="password" placeholder="{{language.password}}">
                        <div id="passwordInvalidFeedback" class="invalid-feedback "></div>
                      </div>
                      <div class="form-group">
                        <label for="language" id="systemLanguage">{{language.systemLanguage}}</label>
                        <select id="cmbLanguages" name="cmbLanguages" class="form-control">
                         {{{ languageOptions }}}
                        </select>
                      </div>
                      <div class="form-check">
                        <input type="checkbox" checked="true" class="form-check-input" id="saveUsername">
                        <label class="form-check-label" id="saveUsernameInfo" for="saveUsername">{{language.saveUsername}}</label>
                      </div>
                      <div class="col right-buttons">
                          <button type="button" id="btnLogin" class="btn btn-success">{{language.login}}</button>
                          <button type="button" id="btnExit" class="btn btn-primary">{{language.exit}}</button>
                      </div>
                      <div class="col bottom-align-text signin-text">
                          <h6><span id="dontHaveAnAccount">{{language.dontHaveAnAccount}}</span> <a id="createAccount" href="#">{{language.createYourOwnAccount}}</a></h6>
                      </div>
                      <div class="col bottom-align-text center-text">
                        <h6 id="pebutraInfo">{{language.pebutraInfo}}</h6>
                      </div>
                    </form>
              </div>
            </div> 
          </div>
  </body>
</html>
